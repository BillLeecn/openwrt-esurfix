{"name":"OpenWRT-eSurfix","tagline":"","body":"# 天翼校园宽带路由器解决方案\r\n天翼校园客户端 (eSurfing) 使用了修改过的 CHAP 进行身份认证。在 Windows 下，通过 \r\nNDIS filter 在内核空间拦截并修改 CHAP response 数据包. 在 Mac OS X 下，通过修改\r\n过的 pppd 进行身份认证。\r\n\r\n本项目通过 MITM 方式，将来自 access concentrator 的 CHAP challenge 重放给天翼客\r\n户端, 取得 response, 以完成身份认证。\r\n\r\n## 使用手册\r\n### Prerequisites\r\n为了通过路由器使用宽带，您需要：\r\n\r\n1. 1台已安装 OpenWRT 12.09(Attitude Adjustment) 的路由器。\r\n2. 1台已安装天翼校园客户端的计算机\r\n3. 2根以太网电缆\r\n\r\n为了完成路由器的安装过程，您需要：\r\n\r\n1. 1台运行 Linux 并可访问互联网的计算机\r\n2. 知道您的路由器的 CPU 体系\r\n3. 熟悉 vim, ssh, make 的使用\r\n\r\n### Compile\r\n#### 安装编译依赖\r\n参见 http://wiki.openwrt.org/doc/howto/buildroot.exigence\r\n\r\n#### 获得源代码\r\n```\r\ngit clone https://github.com/BillLeecn/openwrt-esurfix.git openwrt-esurfix\r\ncd  openwrt-esurfix\r\ngit checkout integrate-chap-proxy\r\n```\r\n\r\n#### 获得初始配置\r\n在 [OpenWRT 12.09 下载页](http://downloads.openwrt.org/attitude_adjustment/12.09/)\r\n找到您的路由器对应的 CPU 体系，访问其中的 generic/ 目录，下载 config.CPU体系_generic, 保存为 .config\r\n\r\n#### 编译\r\n```\r\nmake defconfig\r\nmake download\r\nmake\r\n```\r\n\r\n### Install\r\n#### 安装并配置 rp-pppoe-server\r\n在 [OpenWRT 12.09 下载页](http://downloads.openwrt.org/attitude_adjustment/12.09/) 找到您的路由器对应的 CPU 体系，访问其中的 generic/packages/ 目录，找到并下载 rp-pppoe-server.\r\n\r\n将下载到的 ipk 上传到路由器\r\n\r\n```\r\nscp rp-pppoe-server_*.ipk root@192.168.1.1:/tmp\r\n```\r\n\r\n用 ssh 登入路由器，安装 rp-pppoe-server.\r\n\r\n```\r\nssh root@192.168.1.1\r\nopkg install /tmp/rp-pppoe-server_*.ipk\r\n```\r\n\r\n配置 rp-pppoe-server\r\n\r\n```\r\nvim /etc/default/pppoe-server\r\n```\r\n\r\n将 OPTIONS=\"-C MyRouter -I eth2\" 改成 OPTIONS=\"-k -C MyRouter -I 您的路由器的LAN口\".\r\n\r\n完成后登出路由器\r\n```\r\nexit\r\n```\r\n\r\n#### 安装 chap-proxy 与修改的 pppd\r\n```\r\nscp bin/您的CPU体系/packages/ppp_*.ipk root@192.168.1.1:/tmp\r\nscp bin/您的CPU体系/packages/chap-proxy_*.ipk root@192.168.1.1:/tmp\r\nssh root@192.168.1.1\r\nopkg install /tmp/ppp_*.ipk\r\nopkg install /tmp/chap-proxy_*.ipk\r\n```\r\n\r\n#### 配置 chap-proxy\r\n```\r\nvim /usr/bin/connect_script\r\n```\r\n\r\n将 username \"^#01username\" 修改为 username \"^#01您的宽带号码\", \r\nifname nic-eth0.2 修改为 ifname nic-您的WAN口.\r\n\r\n```\r\nvim /etc/config/network\r\n```\r\n\r\n找到 config interface 'wan' 一节，将 option proto 设置为 'static'.\r\n\r\n#### 最后的配置\r\n关闭防火墙与 QoS\r\n\r\n```\r\n/etc/init.d/qos disable\r\n/etc/init.d/firewall disable\r\n```\r\n\r\n启用 pppoe-server 与 chap-proxy\r\n\r\n```\r\n/etc/init.d/pppoe-server enable\r\n/etc/init.d/chap-proxy enable\r\n```\r\n\r\n重启路由器\r\n\r\n```\r\nreboot\r\n```\r\n\r\n### Usage\r\n#### 连线\r\n将 WAN 口连接到宽带端口，LAN 口连接到已安装天翼客户端的机器\r\n\r\n#### 连接\r\n通过 ssh 登入路由器，执行 logread -f 查看 log 输出。\r\n\r\n使用天翼客户端连接有线宽带，若连接成功，客户端会提示用户名密码错误，同时 log 将输出 IP 地址\r\n与 DNS 地址。\r\n\r\n完成后按 Ctrl+C 中断 log 输出。\r\n\r\n#### 配置 DNS\r\n在路由器上编辑 /tmp/resolv.conf.auto, 写入\r\n\r\n```\r\nnameserver DNS地址1\r\nnameserver DNS地址2\r\n```\r\n\r\n#### 配置 NAT\r\n在路由器上执行\r\n\r\n```\r\niptables -t nat -I POSTROUTING -s 192.168.1.0/24 -o wan -j MASQUERADE\r\n```\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}